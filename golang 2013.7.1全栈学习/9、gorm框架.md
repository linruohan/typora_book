# gorm框架   数据库---对象关系模型

[toc]



## 4个优势

1. 规范一致代码工整
2. 减少一定的工作量
3. 对于一些通用系统部署更方便
4. 解耦数据库与数据访问层，更加方便数据库引擎

## 4个弊端

1. 数据访问层并不会因为使用ORM而显著减少
2. 大量使用反射，导致程序性能不佳
3. 一个没有SQL基础的开发人员，大概率不能通过orm构建正确的sql
4. orm提供的大量关系接口，数据流大情况下会导致i查询性能显著下降

## gorm的基本使用和推荐使用

```bash
https://gorm.io/zh_CN/docs
```

约定

![image-20230709090739745](imgs/image-20230709090739745.png)

![image-20230709090714931](imgs/image-20230709090714931.png)

复杂字段

![image-20230709091036591](imgs/image-20230709091036591.png)

时间

![image-20230709091144627](imgs/image-20230709091144627.png)

结构体

![image-20230709091217672](imgs/image-20230709091217672.png)

![image-20230709091209345](imgs/image-20230709091209345.png)

字段标签

![image-20230709091239157](imgs/image-20230709091239157.png)

![image-20230709091406016](imgs/image-20230709091406016.png)

##   代码

```bash
go get -u gorm.io/gorm   // gorm
go get -u gorm.io/driver/mysql   // mysql
```

### 创建数据库连接

![image-20230709094313413](imgs/image-20230709094313413.png)

![image-20230709094326136](imgs/image-20230709094326136.png)

### model定义：表格字段

![image-20230709094737492](imgs/image-20230709094737492.png)

### 迁移migration：建表 修改表

自动迁移

![image-20230709094913610](imgs/image-20230709094913610.png)

## 数据库操作

### 入库操作

==create.go==

1. 指定表或者model
2. 正向选择或者反向选择哪些字段入库
3. 单条记录或披露，披露可以指定每批次处理记录条数

![image-20230709095757339](imgs/image-20230709095757339.png) ![image-20230709095948427](imgs/image-20230709095948427.png)

![image-20230709095928315](imgs/image-20230709095928315.png)

![image-20230709100033867](imgs/image-20230709100033867.png)

![image-20230709100705903](imgs/image-20230709100705903.png)

![image-20230709100904429](imgs/image-20230709100904429.png)

批量插入

![image-20230709101020650](imgs/image-20230709101020650.png)

批量分批操作，每次2条记录入库

![image-20230709101141909](imgs/image-20230709101141909.png)

![image-20230709101236127](imgs/image-20230709101236127.png)

### 数据查询

1. 指定表或者model
   ![image-20230709101511773](imgs/image-20230709101511773.png)
2. 正向选择或反向选择查询字段
3. where子句构建（and or in not等）
4. orderby 子句
5. group having子句
6. limit offset 子句
7. 查询条目，一条或多条
8. 结果填充，填充到对象 、集合 、切片

map： model first last

![image-20230709101859304](imgs/image-20230709101859304.png)

![image-20230709101915579](imgs/image-20230709101915579.png)

take： map

![image-20230709102143223](imgs/image-20230709102143223.png)

查询多条记录

![image-20230709102343987](imgs/image-20230709102343987.png)

![image-20230709102332464](imgs/image-20230709102332464.png)

### 数据更新

1. 指定表或者model
2. 选择更新字段
3. where子句

### 删除

1. 指定表或者model
2. where子句

### 事务

1. 普通事务

   ![image-20230709103127552](imgs/image-20230709103127552.png)

   只需要return error会自动回滚

   return new就会自动提交

   ![image-20230709102619422](imgs/image-20230709102619422.png)
2. 嵌套事务

   ![image-20230709102902349](imgs/image-20230709102902349.png)

   ![image-20230709103037836](imgs/image-20230709103037836.png)

   
3. 手动事务

   ![image-20230709102928163](imgs/image-20230709102928163.png)
4. savepoint 和 rollback

![image-20230709102940608](imgs/image-20230709102940608.png)

![image-20230709103225924](imgs/image-20230709103225924.png)

![image-20230709103106597](imgs/image-20230709103106597.png)