# Go语言Etcd实现服务注册和发现

[toc]





## go语言客户端etcd基本操作

docs https://etcd.io/docs/v3.5

源码 https://github.com/etcd-io/etcd

redhat etcd docker官方镜像 https://quay.io/repository/coreos/etcd?tab=tags&tag=latest

安全： https://play.etcd.io/install

客户端： https://github.com/etcd-id/etcd/tree/main/client/v3

### etcd架构

![image-20230715190159434](imgs/image-20230715190159434.png)

角色：leader  follower  候选  只读（不参与选举）

### 搭建etcd集群

![image-20230715190509639](imgs/image-20230715190509639.png)

![image-20230715190633782](imgs/image-20230715190633782.png)

![image-20230715190847001](imgs/image-20230715190847001.png)

模拟使用etcd客户端

![image-20230715191000566](imgs/image-20230715191000566.png)

![image-20230715191026129](imgs/image-20230715191026129.png)

![image-20230715191110572](imgs/image-20230715191110572.png)

![image-20230715191147083](imgs/image-20230715191147083.png)

添加etcd节点

![image-20230715191214266](imgs/image-20230715191214266.png)



![image-20230715191330868](imgs/image-20230715191330868.png)

![image-20230715191454366](imgs/image-20230715191454366.png)

### get put del操作

![image-20230715191632039](imgs/image-20230715191632039.png)

#### put

![image-20230715192006695](imgs/image-20230715192006695.png)

![image-20230715192014190](imgs/image-20230715192014190.png)

#### get

![image-20230715192034842](imgs/image-20230715192034842.png)

![image-20230715192502715](imgs/image-20230715192502715.png)

![image-20230715192534050](imgs/image-20230715192534050.png)









#### del

![image-20230715192432850](imgs/image-20230715192432850.png)

![image-20230715192539849](imgs/image-20230715192539849.png)

![image-20230715192549959](imgs/image-20230715192549959.png)



### 权限  Auth

![image-20230715192732636](imgs/image-20230715192732636.png)

## etcd消息发布订阅是什么逻辑

## 服务注册和服务发现的具体实现

![image-20230715193206605](imgs/image-20230715193206605.png)



![image-20230715193637002](imgs/image-20230715193637002.png)



#### proto



![image-20230715194244397](imgs/image-20230715194244397.png)

![image-20230715193838661](imgs/image-20230715193838661.png)

生成代码：

![image-20230715193904379](imgs/image-20230715193904379.png)

#### server：

![image-20230715194304027](imgs/image-20230715194304027.png)

![image-20230715194506092](imgs/image-20230715194506092.png)

#### client

![image-20230715194824781](imgs/image-20230715194824781.png)

![image-20230715194835297](imgs/image-20230715194835297.png)

![image-20230715194904436](imgs/image-20230715194904436.png)

#### client + server

![image-20230715194944772](imgs/image-20230715194944772.png)

![image-20230715194951329](imgs/image-20230715194951329.png)

### 服务注册





#### 服务端开启注册

server/server.go  注册需要开启协程

![image-20230715202153337](imgs/image-20230715202153337.png)

![image-20230715202237641](imgs/image-20230715202237641.png)

![image-20230715202250826](imgs/image-20230715202250826.png)

![image-20230715202312706](imgs/image-20230715202312706.png)

![image-20230715202354749](imgs/image-20230715202354749.png)

### 服务发现

discovery.go

#### dicovery ServiceRegister

![image-20230715195230849](imgs/image-20230715195230849.png)

![image-20230715200724948](imgs/image-20230715200724948-1689422845395-2.png)

![image-20230715200825752](imgs/image-20230715200825752.png)	

![image-20230715200904938](imgs/image-20230715200904938.png)

etcd的事务

![image-20230715200937226](imgs/image-20230715200937226.png)

![image-20230715201057404](imgs/image-20230715201057404.png)

![image-20230715201734078](imgs/image-20230715201734078.png)

续约： 死循环

![image-20230715201827939](imgs/image-20230715201827939.png)



#### serviceDiscovery

![image-20230715202745531](imgs/image-20230715202745531.png)



#### watchservice

![image-20230715202904518](imgs/image-20230715202904518.png)

![image-20230715203154650](imgs/image-20230715203154650.png)

![image-20230715203231306](imgs/image-20230715203231306.png)![image-20230715203245903](imgs/image-20230715203245903.png)

开始watch

![image-20230715203526514](imgs/image-20230715203526514.png)

![image-20230715203544132](imgs/image-20230715203544132.png)

​	



![image-20230715203026118](imgs/image-20230715203026118.png)

### client调用watchservice

![image-20230715203702648](imgs/image-20230715203702648.png)

![image-20230715203923633](imgs/image-20230715203923633.png)



首次不存在租约，get访问时会注册，然后重试后就会有创建租约

![image-20230715204152717](imgs/image-20230715204152717.png)

![image-20230715204109689](imgs/image-20230715204109689.png)

![image-20230715204458697](imgs/image-20230715204458697.png)

![image-20230715204558744](imgs/image-20230715204558744.png)

![image-20230715204625190](imgs/image-20230715204625190.png)

修改端口后client断开

![image-20230715204818452](imgs/image-20230715204818452.png)

![image-20230715204839208](imgs/image-20230715204839208.png)

![image-20230715205748225](imgs/image-20230715205748225.png)

![image-20230715205847704](imgs/image-20230715205847704.png)

![image-20230715205900912](imgs/image-20230715205900912.png)

![image-20230715210113934](imgs/image-20230715210113934.png)